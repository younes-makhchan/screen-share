<!DOCTYPE html>
<html>
<head>
    <title>Screen Share Master</title>
</head>
<body>
    <button id="startShare">Start Screen Share</button>
    <canvas id="canvas" style="display:none;"></canvas>
    <script>
        const ws = new WebSocket('wss://youtube.makhchan.tech:9090');
        let stream;
        let interval;
        
        ws.onopen = () => {
            ws.send(JSON.stringify({client_type: 'master'}));
        };

        document.getElementById('startShare').addEventListener('click', async () => {
            try {
                if (stream) {
                    stopSharing();
                }
                stream = await navigator.mediaDevices.getDisplayMedia({video: true});
                const video = document.createElement('video');
                video.srcObject = stream;
                await video.play();

                const canvas = document.getElementById('canvas');
                const context = canvas.getContext('2d');

                function captureAndSendFrame() {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const screenData = canvas.toDataURL('image/jpeg', 0.7);
                    ws.send(JSON.stringify({screen: screenData}));
                }

                interval = setInterval(captureAndSendFrame, 1000); // Send screen every second

                stream.getVideoTracks()[0].onended = stopSharing;
            } catch (error) {
                console.error('Error starting screen share:', error);
            }
        });

        function stopSharing() {
            if (interval) {
                clearInterval(interval);
                interval = null;
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            console.log('Screen sharing stopped');
        }

        window.addEventListener('beforeunload', stopSharing);
    </script>
</body>
</html>